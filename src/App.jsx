import React, { useState } from "react";

/* ===== Pomocnicze ===== */
const d = (s) => Math.floor(Math.random() * s) + 1;
const statMod = (v) => {
  if (v <= 1) return 0;
  if (v <= 4) return 1;
  if (v <= 7) return 2;
  if (v <= 10) return 3;
  return 4;
};

/* ===== Bro≈Ñ ===== */
const weaponData = {
  sword: { name: "Miecz kr√≥tki", stat: "STR", dmgDie: 6 },
  bow: { name: "≈Åuk", stat: "PER", dmgDie: 6 },
  staff: { name: "Kij magiczny", stat: "MAG", dmgDie: 4 },
};

/* ===== Typy wrog√≥w ===== */
const enemyTypes = {
  "Elfi Kultysta": {
    hp: 45, maxHp: 45, essence: 20, maxEssence: 20,
    armor: 4, magicDefense: 4, toHit: 8, defense: 10,
    spells: ["Mroczny Pakt", "Wyssanie ≈ºycia", "Magiczny pocisk"]
  },
  "Szpieg Magmaratora": {
    hp: 30, maxHp: 30, essence: 20, maxEssence: 20,
    armor: 2, magicDefense: 2, toHit: 10, defense: 8,
    spells: ["Magiczny pocisk", "Wybuch energii"]
  }
};

/* ===== Tworzenie nowej postaci ===== */
const makeChar = () => ({
  name: "",
  race: "Cz≈Çowiek",
  clazz: "Wojownik",

  STR: null, DEX: null, PER: null, MAG: null, CHA: null,
  armor: 0, magicDefense: 0,

  hp: 20, maxHp: 20,
  essence: 20, maxEssence: 20,

  actionsLeft: 2,

  // Rasowe
  humanCharges: [false, false, false, false, false],
  humanBuff: null,
  elfChargeUsed: false,
  elfChargedTurn: null,
  dwarfPassiveArmed: false,
  dwarfHibernating: false,
  dwarfHibernateTurns: 0,
  faeykaiChargesLeft: 3,
  faeykaiMaskBroken: false,
  faeykaiOutsideHomeland: true,
  effects: [],

  // Klasowe
  classUsed: false,
  warriorReady: false,
  archerReady: false,
  shooterReady: false,
  mageReady: false,
  mageShield: 0,
});

/* ====== G≈Å√ìWNY KOMPONENT ====== */
export default function BattleSimulator() {
  const [sets, setSets] = useState([makeChar(), makeChar(), makeChar(), makeChar()]);
  const [lockedSets, setLockedSets] = useState([false, false, false, false]);
  const [activeSet, setActiveSet] = useState(0);

  const [log, setLog] = useState([]);
  const [turn, setTurn] = useState(1);

  const [enemies, setEnemies] = useState([]); // instancje wrog√≥w
  const [enemyWeaponChoice, setEnemyWeaponChoice] = useState("sword");
  const [selectedEnemyId, setSelectedEnemyId] = useState(null);
  const [enemyTargetPlayer, setEnemyTargetPlayer] = useState(0);

  const addLog = (line) => {
    const stamp = new Date().toLocaleTimeString();
    setLog((prev) => [`[${stamp}] ${line}`, ...prev]);
  };

  /* ====== Odpoczynek ====== */
  const restSet = (i) => {
    setSets((prev) => {
      const n = [...prev];
      const c = { ...n[i] };

      c.hp = c.maxHp;
      c.essence = c.maxEssence;
      c.actionsLeft = 2;

      // reset rasowych/klasowych zdolno≈õci
      c.humanCharges = [false, false, false, false, false];
      c.humanBuff = null;
      c.elfChargeUsed = false;
      c.dwarfPassiveArmed = false;
      c.dwarfHibernating = false;
      c.dwarfHibernateTurns = 0;
      c.faeykaiChargesLeft = 3;
      c.faeykaiMaskBroken = false; // reset maski
      c.effects = [];

      n[i] = c;
      return n;
    });
    addLog(`üí§ Postaƒá ${i + 1} odpoczƒô≈Ça i odzyska≈Ça si≈Çy.`);
  };

  /* ====== Render graczy ====== */
  const renderPlayer = (c, i) => (
    <div key={i} style={{ border: "1px solid #ccc", padding: 8, marginBottom: 8 }}>
      <h3>Postaƒá {i + 1}</h3>
      <div>Imiƒô: <input value={c.name} onChange={e => {
        const v = e.target.value;
        setSets(prev => { const n = [...prev]; n[i] = { ...n[i], name: v }; return n; });
      }} /></div>
      <div>Rasa:
        <select value={c.race} onChange={e => {
          const v = e.target.value;
          setSets(prev => { const n = [...prev]; n[i] = { ...n[i], race: v }; return n; });
        }}>
          <option>Cz≈Çowiek</option>
          <option>Elf</option>
          <option>Krasnolud</option>
          <option>Faeykai</option>
        </select>
      </div>
      <div>Klasa:
        <select value={c.clazz} onChange={e => {
          const v = e.target.value;
          setSets(prev => { const n = [...prev]; n[i] = { ...n[i], clazz: v }; return n; });
        }}>
          <option>Wojownik</option>
          <option>≈Åucznik</option>
          <option>Strzelec</option>
          <option>Mag</option>
          <option>Dyplomata</option>
        </select>
      </div>

      <div>HP: {c.hp}/{c.maxHp}</div>
      <div>Esencja: {c.essence}/{c.maxEssence}</div>
      <div>Akcje: {c.actionsLeft}</div>

      {/* Zatwierd≈∫ / Odpoczynek */}
      <div style={{ display: "flex", gap: 8, marginTop: 8 }}>
        <button onClick={() => restSet(i)}>üí§ Odpocznij</button>
      </div>
    </div>
  );
  /* ===================== POMOC / WSP√ì≈ÅDZIELONE ===================== */
  const getActiveChar = () => sets[activeSet] || makeChar();

  const lockSet = (i) => {
    const s = sets[i];
    const statsOk = ["STR","DEX","PER","MAG","CHA"].every(k => s[k] !== null && s[k] !== "");
    if (!statsOk) return addLog(`‚ùå Postaƒá ${i+1}: uzupe≈Çnij wszystkie statystyki.`);
    setLockedSets(prev => { const n=[...prev]; n[i]=true; return n; });
    addLog(`‚úîÔ∏è Postaƒá ${i+1} (${s.name||`Postaƒá ${i+1}`}) zosta≈Ça zatwierdzona.`);
  };

  const spendPlayerAction = (i) => {
    let ok = false;
    setSets(prev => {
      const n=[...prev];
      const c={...n[i]};
      if ((c.actionsLeft||0)>0) { c.actionsLeft -= 1; ok = true; }
      n[i]=c; return n;
    });
    return ok;
  };

  /* ===================== UI pasywek rasowych ===================== */
  const RacePassivesPanel = ({ c, i }) => {
    return (
      <div style={{ marginTop: 10, borderTop: "1px dashed #ccc", paddingTop: 8 }}>
        {/* LUDZIE */}
        {c.race === "Cz≈Çowiek" && (
          <div style={{ marginBottom: 10 }}>
            <div style={{ fontWeight: 600, marginBottom: 4 }}>Ludzka wytrwa≈Ço≈õƒá (5√ó/odpoczynek):</div>
            <div style={{ display: "flex", gap: 6, alignItems: "center", flexWrap: "wrap" }}>
              {c.humanCharges.map((used, idx) => {
                const isPending = c.humanPendingIdx === idx && !used;
                return (
                  <div
                    key={idx}
                    onClick={()=>{
                      if (used) return;
                      if (!spendPlayerAction(i)) { addLog("‚ùå Brak akcji (Ludzie)."); return; }
                      setSets(prev => { const n=[...prev]; n[i] = { ...n[i], humanPendingIdx: idx }; return n; });
                    }}
                    title={used ? "Zu≈ºyte" : "Kliknij, by u≈ºyƒá (zu≈ºywa 1 akcjƒô)"}
                    style={{
                      width: 18, height: 18,
                      background: used || isPending ? "#c62828" : "#2e7d32",
                      borderRadius: 3, cursor: used ? "not-allowed" : "pointer",
                      border: "1px solid #0004"
                    }}
                  />
                );
              })}
              {c.humanPendingIdx != null && !c.humanCharges[c.humanPendingIdx] && (
                <>
                  <select
                    value={c.humanPendingChoice || "dmg"}
                    onChange={(e)=>setSets(prev=>{
                      const n=[...prev]; n[i] = { ...n[i], humanPendingChoice: e.target.value }; return n;
                    })}
                  >
                    <option value="dmg">+2 obra≈ºe≈Ñ (do ko≈Ñca tury)</option>
                    <option value="tohit">+2 do trafienia (do ko≈Ñca tury)</option>
                    <option value="hp">+2 HP (natychmiast)</option>
                  </select>
                  <button
                    onClick={()=>{
                      setSets(prev=>{
                        const n=[...prev];
                        const me={...n[i]};
                        const idx = me.humanPendingIdx;
                        if (idx==null || me.humanCharges[idx]) return n;
                        const choice = me.humanPendingChoice || "dmg";
                        me.humanCharges = me.humanCharges.map((u,k)=> k===idx ? true : u);
                        me.humanPendingIdx = null;

                        if (choice==="hp") {
                          me.hp = Math.min(me.maxHp||20, (me.hp||0)+2);
                          me.humanBuff = null;
                        } else {
                          me.humanBuff = { type: choice, expiresTurn: turn }; // wygasa przy nextTurn
                        }

                        n[i]=me; return n;
                      });
                      addLog(`üë§ P${i+1} u≈ºywa ludzkiej zdolno≈õci: ${c.humanPendingChoice==="dmg"?"+2 DMG":c.humanPendingChoice==="tohit"?"+2 TO-HIT":"+2 HP"}.`);
                    }}
                  >
                    Zastosuj
                  </button>
                </>
              )}
            </div>
            <small style={{ opacity: .7 }}>Efekt nie stackuje siƒô; wygasa po tej turze. U≈ºycie zu≈ºywa 1 akcjƒô.</small>
          </div>
        )}

        {/* ELF */}
        {c.race === "Elf" && (
          <div style={{ marginBottom: 10 }}>
            <div style={{ fontWeight: 600, marginBottom: 4 }}>Elfie na≈Çadowanie (1√ó/odpoczynek):</div>
            <div
              onClick={()=>{
                if (c.elfChargeUsed) return;
                if (!spendPlayerAction(i)) { addLog("‚ùå Brak akcji (Elf)."); return; }
                setSets(prev=>{
                  const n=[...prev]; const me={...n[i]};
                  me.elfChargeUsed = true; me.elfChargedTurn = turn;
                  n[i]=me; return n;
                });
                addLog(`üå©Ô∏è P${i+1} (Elf) ≈Çaduje eksplozjƒô ‚Äî wybuch w nastƒôpnej turze (elf ‚àí5 HP; wszyscy wrogowie ‚àí10 HP i og≈Çuszenie 1 turƒô).`);
              }}
              title={c.elfChargeUsed ? "Zu≈ºyte do odpoczynku" : "Kliknij, by na≈Çadowaƒá (zu≈ºywa 1 akcjƒô)"}
              style={{
                width: 18, height: 18,
                background: c.elfChargeUsed ? "#c62828" : "#2e7d32",
                borderRadius: 3, cursor: c.elfChargeUsed ? "not-allowed" : "pointer",
                border: "1px solid #0004"
              }}
            />
            <div style={{ marginTop: 4, fontSize: 12, opacity: .8 }}>
              {c.elfChargeUsed ? "Na≈Çadowano ‚Äî eksplozja w nastƒôpnej turze." : "Klikniƒôcie zu≈ºywa 1 akcjƒô."}
            </div>
          </div>
        )}

        {/* KRASNOLUD */}
        {c.race === "Krasnolud" && (
          <div style={{ marginBottom: 10 }}>
            <div style={{ fontWeight: 600, marginBottom: 4 }}>Krasnoludzka hibernacja (uzbrojenie):</div>
            <button
              onClick={()=>{
                if (c.dwarfPassiveArmed) return;
                if (!spendPlayerAction(i)) { addLog("‚ùå Brak akcji (Krasnolud)."); return; }
                setSets(prev=>{
                  const n=[...prev]; n[i] = { ...n[i], dwarfPassiveArmed: true }; return n;
                });
                addLog(`‚õèÔ∏è P${i+1} (Krasnolud) uzbraja hibernacjƒô. Po spadku do 0 HP ‚Äî hibernacja 2 tury (niewra≈ºliwy), mo≈ºna podnie≈õƒá.`);
              }}
              disabled={c.dwarfPassiveArmed}
            >
              {c.dwarfPassiveArmed ? "Uzbrojone" : "Uzbr√≥j hibernacjƒô (1 akcja)"}
            </button>
            <div style={{ marginTop: 4, fontSize: 12, opacity: .8 }}>
              Po podniesieniu (25% Max HP) przycisk zn√≥w bƒôdzie dostƒôpny.
            </div>
          </div>
        )}

        {/* FAEYKAI */}
        {c.race === "Faeykai" && (
          <div style={{ marginBottom: 10 }}>
            <div style={{ display: "flex", gap: 8, alignItems:"center", flexWrap: "wrap" }}>
              <div style={{ fontWeight: 600 }}>Faeykai (3√ó/odpoczynek):</div>
              <div>Maska: {c.faeykaiMaskBroken ? "üî¥ pƒôkniƒôta" : "üü¢ sprawna"} <small style={{opacity:.7}}>(odnawia siƒô przy odpoczynku; pƒôka &lt;21% max HP)</small></div>
            </div>

            <div style={{ display: "flex", gap: 6, marginTop: 4 }}>
              {Array.from({ length: 3 }).map((_, idx) => {
                const used = idx >= (3 - (c.faeykaiChargesLeft || 0));
                return (
                  <div
                    key={idx}
                    onClick={()=>{
                      if (used) return;
                      if (!spendPlayerAction(i)) { addLog("‚ùå Brak akcji (Faeykai)."); return; }
                      // otw√≥rz mini-konfigurator w stanie postaci
                      setSets(prev=>{
                        const n=[...prev]; const me={...n[i]};
                        me.faeykaiPending = { mode:"bless", targetKind:"player", playerIndex:0, enemyId:"" };
                        n[i]=me; return n;
                      });
                    }}
                    title={used ? "Zu≈ºyte" : "Kliknij, by u≈ºyƒá (zu≈ºywa 1 akcjƒô)"}
                    style={{
                      width: 18, height: 18,
                      background: used ? "#c62828" : "#2e7d32",
                      borderRadius: 3, cursor: used ? "not-allowed" : "pointer",
                      border: "1px solid #0004"
                    }}
                  />
                );
              })}
            </div>

            {c.faeykaiPending && (
              <div style={{ display: "grid", gridTemplateColumns: "repeat(3, minmax(140px, 1fr))", gap: 8, marginTop: 6 }}>
                <label>Efekt
                  <select
                    value={c.faeykaiPending.mode}
                    onChange={(e)=>setSets(prev=>{
                      const n=[...prev]; const me={...n[i]};
                      me.faeykaiPending = { ...me.faeykaiPending, mode: e.target.value };
                      n[i]=me; return n;
                    })}
                  >
                    <option value="bless">B≈Çogos≈Çawie≈Ñstwo (+3 HP przez 3 tury)</option>
                    <option value="curse">Przekle≈Ñstwo (‚àí3 do trafienia przez 3 tury)</option>
                  </select>
                </label>

                <label>Cel
                  <select
                    value={c.faeykaiPending.targetKind}
                    onChange={(e)=>setSets(prev=>{
                      const n=[...prev]; const me={...n[i]};
                      me.faeykaiPending = { ...me.faeykaiPending, targetKind: e.target.value };
                      n[i]=me; return n;
                    })}
                  >
                    <option value="player">Postaƒá</option>
                    <option value="enemy">Wr√≥g</option>
                  </select>
                </label>

                {c.faeykaiPending.targetKind === "player" ? (
                  <label>Postaƒá
                    <select
                      value={c.faeykaiPending.playerIndex}
                      onChange={(e)=>setSets(prev=>{
                        const n=[...prev]; const me={...n[i]};
                        me.faeykaiPending = { ...me.faeykaiPending, playerIndex: Number(e.target.value) };
                        n[i]=me; return n;
                      })}
                    >
                      {sets.map((_, idx)=> <option key={idx} value={idx}>Postaƒá {idx+1}</option>)}
                    </select>
                  </label>
                ) : (
                  <label>Wr√≥g
                    <select
                      value={c.faeykaiPending.enemyId}
                      onChange={(e)=>setSets(prev=>{
                        const n=[...prev]; const me={...n[i]};
                        me.faeykaiPending = { ...me.faeykaiPending, enemyId: e.target.value };
                        n[i]=me; return n;
                      })}
                    >
                      <option value="">‚Äî</option>
                      {enemies.map(e => <option key={e.id} value={e.id}>{e.name}</option>)}
                    </select>
                  </label>
                )}

                <div style={{ gridColumn: "1 / -1", display: "flex", gap: 8 }}>
                  <button
                    onClick={()=>{
                      const p = c.faeykaiPending;
                      if (!p) return;
                      // zu≈ºyj ≈Çadunek
                      setSets(prev=>{
                        const n=[...prev];
                        const me={...n[i]};
                        me.faeykaiChargesLeft = Math.max(0, (me.faeykaiChargesLeft||0) - 1);
                        n[i]=me; return n;
                      });

                      if (p.mode==="bless") {
                        if (p.targetKind==="player") {
                          setSets(prev=>{
                            const n=[...prev]; const trg={...n[p.playerIndex]};
                            trg.effects = [ ...(trg.effects||[]), { type:"bless", value:3, turnsLeft:3 } ];
                            n[p.playerIndex] = trg; return n;
                          });
                          addLog(`üå± Faeykai P${i+1} b≈Çogos≈Çawi P${(p.playerIndex)+1}: +3 HP przez 3 tury.`);
                        } else {
                          // b≈Çogos≈Çawie≈Ñstwo na wroga ‚Äì uproszczenie: +3 HP/ turƒô przez 3 tury
                          setEnemies(prev => prev.map(e => e.id===p.enemyId ? { ...e, bless:{ turnsLeft:3, value:3 } } : e));
                          addLog(`üå± Faeykai P${i+1} b≈Çogos≈Çawi ${p.enemyId}: +3 HP przez 3 tury.`);
                        }
                      } else {
                        if (p.targetKind==="player") {
                          setSets(prev=>{
                            const n=[...prev]; const trg={...n[p.playerIndex]};
                            trg.effects = [ ...(trg.effects||[]), { type:"curseToHit", value:3, turnsLeft:3 } ];
                            n[p.playerIndex] = trg; return n;
                          });
                          addLog(`üåë Faeykai P${i+1} przeklina P${(p.playerIndex)+1}: ‚àí3 do trafienia przez 3 tury.`);
                        } else {
                          // klƒÖtwa na wroga: ‚àí3 do trafienia przez 3 tury (pr√≥g ro≈õnie o 3)
                          setEnemies(prev => prev.map(e => e.id===p.enemyId ? { ...e, cursed:3 } : e));
                          addLog(`üåë Faeykai P${i+1} przeklina ${p.enemyId}: ‚àí3 do trafienia przez 3 tury.`);
                        }
                      }

                      // zamknij konfigurator
                      setSets(prev=>{
                        const n=[...prev]; const me={...n[i]}; me.faeykaiPending = null; n[i]=me; return n;
                      });
                    }}
                  >
                    Zastosuj efekt
                  </button>
                  <button
                    onClick={()=>{
                      setSets(prev=>{
                        const n=[...prev]; const me={...n[i]}; me.faeykaiPending = null; n[i]=me; return n;
                      });
                      addLog("‚ÑπÔ∏è Anulowano konfiguracjƒô Faeykai (akcja pozosta≈Ça zu≈ºyta).");
                    }}
                    style={{ opacity: .8 }}
                  >
                    Anuluj
                  </button>
                </div>
              </div>
            )}
          </div>
        )}
      </div>
    );
  };

  /* ===================== WROGOWIE: generowanie instancji ===================== */
  const [roster, setRoster] = useState({ "Elfi Kultysta": 1, "Szpieg Magmaratora": 0 });

  const createEnemies = () => {
    const list = [];
    Object.entries(roster).forEach(([typeName, count]) => {
      for (let i=1;i<=Number(count||0);i++){
        const base = enemyTypes[typeName];
        list.push({
          id: `${typeName} #${i}`,
          type: typeName,
          name: `${typeName} #${i}`,
          hp: base.hp, maxHp: base.maxHp,
          essence: base.essence, maxEssence: base.maxEssence,
          armor: base.armor, magicDefense: base.magicDefense,
          toHit: base.toHit, defense: base.defense,
          spells: base.spells,
          actionsLeft: 2,
          bless: null,    // {turnsLeft,value}
          cursed: 0       // tury kary do trafienia
        });
      }
    });
    setEnemies(list);
    setSelectedEnemyId(list[0]?.id || null);
    addLog(`üë• Dodano do walki wrog√≥w: ${list.length} szt.`);
  };

  /* ===================== WALKA: gracz ‚Üí wr√≥g (atak broniƒÖ) ===================== */
  const [weaponChoice, setWeaponChoice] = useState("sword");
  const [targetEnemyId, setTargetEnemyId] = useState(null);

  const damageEnemyInstance = (id, amount) => {
    if (amount<=0) return;
    setEnemies(prev => prev.map(e => e.id===id ? { ...e, hp: Math.max(0, e.hp - amount) } : e));
  };

  const doPlayerAttack = () => {
    const i = activeSet;
    if (!lockedSets[i]) return addLog("‚ùå Najpierw zatwierd≈∫ postaƒá.");
    const c = getActiveChar();
    if ((c.actionsLeft||0) <= 0) return addLog("‚ùå Brak akcji.");
    const enemyId = targetEnemyId || selectedEnemyId;
    const enemy = enemies.find(e => e.id===enemyId);
    if (!enemy) return addLog("‚ùå Wybierz wroga.");

    const w = weaponData[weaponChoice];
    const stat = Number(c[w.stat]||0);
    const humanToHit = (c.race==="Cz≈Çowiek" && c.humanBuff?.type==="tohit") ? 2 : 0;

    // Wojownik ‚Äî maksymalny cios (fizyczny) ‚Äì je≈õli kiedy≈õ dodasz prze≈ÇƒÖcznik, tutaj go uwzglƒôdnij
    // (zostawiamy standardowy rzut)
    const roll20 = d(20);
    const toHit = roll20 + stat + humanToHit;
    const hit = toHit >= (enemy.defense || 0);

    let lines = [
      `‚öîÔ∏è P${i+1} atakuje (${w.name}) ‚Üí ${enemy.name}`,
      `üéØ Trafienie: k20=${roll20} + ${w.stat}(${stat})${humanToHit? " + human(+2)": ""} = ${toHit} vs Obrona ${enemy.defense} ‚Üí ${hit? "‚úÖ":"‚ùå"}`
    ];
    if (!hit) { addLog(lines.join("\n")); return; }

    const dmgDie = d(w.dmgDie);
    const humanDmg = (c.race==="Cz≈Çowiek" && c.humanBuff?.type==="dmg") ? 2 : 0;
    const raw = dmgDie + humanDmg;
    const afterArmor = Math.max(0, raw - (enemy.armor||0));
    lines.push(`üó°Ô∏è Obra≈ºenia: k${w.dmgDie}=${dmgDie}${humanDmg? " + human(+2)": ""} = ${raw} ‚àí Pancerz(${enemy.armor||0}) = ${afterArmor}`);

    // Strzelec/≈Åucznik mo≈ºna tu rozwinƒÖƒá o debuffy ‚Äì skracamy, by kod by≈Ç stabilny.

    spendPlayerAction(i);
    addLog(lines.join("\n"));
    damageEnemyInstance(enemy.id, afterArmor);
  };

  /* ===================== WALKA: czar gracza ===================== */
  const PLAYER_SPELLS = {
    "Magiczny pocisk": { cost: 3, dmgDie: 6, type: "damage" },
    "Wybuch energii":  { cost: 5, dmgDie: 4, type: "damage" },
    "Zasklepienie ran":{ cost: 5, healDie: 6, type: "heal" },
    "O≈õlepienie":      { cost: 8, type: "effect" },
  };
  const [playerSpell, setPlayerSpell] = useState("Magiczny pocisk");
  const [healTarget, setHealTarget] = useState(0);

  const nextTurn = () => {
    // gracze: od≈õwie≈º akcje + efekty na turƒô
    setSets(prev => prev.map((c, idx) => {
      const me = { ...c, actionsLeft: 2 };

      // ludzki buff wygasa po turze
      if (me.humanBuff && me.humanBuff.expiresTurn < turn + 1) me.humanBuff = null;

      // Elf ‚Äì eksplozja po 1 turze
      if (me.race === "Elf" && me.elfChargeUsed && me.elfChargedTurn === turn) {
        const before = me.hp||0;
        me.hp = Math.max(0, before - 5);
        addLog(`üå©Ô∏è Elf (P${idx+1}) ‚Äî eksplozja: elf ‚àí5 HP; wrogowie ‚àí10 HP (og≈Çuszenie 1 turƒô ‚Äì skr√≥t).`);
        setEnemies(prevE => prevE.map(e => ({ ...e, hp: Math.max(0, e.hp - 10) })));
        me.elfChargeUsed = false; me.elfChargedTurn = null;
      }

      // Efekty gracza: b≈Çogos≈Çawie≈Ñstwo / klƒÖtwa do trafienia
      if (me.effects?.length) {
        me.effects = me.effects
          .map(ef => {
            if (ef.type==="bless" && ef.turnsLeft>0) {
              me.hp = Math.min(me.maxHp||20, (me.hp||0) + (ef.value||0));
              return { ...ef, turnsLeft: ef.turnsLeft - 1 };
            }
            if (ef.type==="curseToHit" && ef.turnsLeft>0) {
              return { ...ef, turnsLeft: ef.turnsLeft - 1 };
            }
            return { ...ef, turnsLeft: (ef.turnsLeft||0)-1 };
          })
          .filter(ef => ef.turnsLeft>0);
      }

      // Faeykai ‚Äì pƒôkniƒôcie maski przy <21% max HP
      if (me.race === "Faeykai") {
        const thr = Math.ceil((me.maxHp||20) * 0.21);
        if ((me.hp||0) < thr) me.faeykaiMaskBroken = true;
      }

      return me;
    }));

    // wrogowie: odn√≥w akcje, odlicz b≈Çogos≈Çawie≈Ñstwo i klƒÖtwƒô
    setEnemies(prev => prev.map(e => {
      let hp = e.hp;
      let bless = e.bless;
      if (bless?.turnsLeft > 0) {
        hp = Math.min(e.maxHp, hp + (bless.value || 0));
        bless = { ...bless, turnsLeft: bless.turnsLeft - 1 };
      } else {
        bless = null;
      }
      const cursed = Math.max(0, (e.cursed||0) - 1);
      return { ...e, actionsLeft: 2, hp, bless, cursed };
    }));

    setTurn(t => t+1);
    addLog(`‚è±Ô∏è Rozpoczyna siƒô tura ${turn + 1}.`);
  };

  const castPlayerSpell = () => {
    const i = activeSet;
    if (!lockedSets[i]) return addLog("‚ùå Najpierw zatwierd≈∫ postaƒá.");
    const c = getActiveChar();
    if ((c.actionsLeft||0) <= 0) return addLog("‚ùå Brak akcji.");

    const spell = PLAYER_SPELLS[playerSpell];
    if (!spell) return;
    if ((c.essence||0) < spell.cost) return addLog(`‚ùå Esencja: ${c.essence} < koszt ${spell.cost}.`);

    // pobierz koszt
    setSets(prev => { const n=[...prev]; n[i] = { ...n[i], essence: (n[i].essence||0) - spell.cost }; return n; });
    spendPlayerAction(i);

    let lines = [`‚ú® P${i+1} rzuca ‚Äû${playerSpell}‚Äù ‚Äî koszt ${spell.cost} (Esencja po: ${(c.essence||0)-spell.cost})`];

    // HEAL
    if (spell.type==="heal") {
      const roll = d(spell.healDie);
      setSets(prev => {
        const n=[...prev]; const trg={...n[healTarget]};
        trg.hp = Math.min(trg.maxHp||20, (trg.hp||0) + roll);
        n[healTarget]=trg; return n;
      });
      lines.push(`üíö Leczenie: k${spell.healDie}=${roll} ‚Üí P${healTarget+1} +${roll} HP`);
      return addLog(lines.join("\n"));
    }

    // DAMAGE / EFFECT
    const enemyId = targetEnemyId || selectedEnemyId;
    const enemy = enemies.find(e => e.id===enemyId);
    if (!enemy) return addLog("‚ùå Wybierz wroga.");

    const MAG = Number(c.MAG||0);
    const faeykaiPenalty = (c.race==="Faeykai" && c.faeykaiOutsideHomeland) ? 5 : 0;
    const maskPenalty = (c.race==="Faeykai" && c.faeykaiMaskBroken) ? 3 : 0;
    const humanToHit = (c.race==="Cz≈Çowiek" && c.humanBuff?.type==="tohit") ? 2 : 0;
    const toHitPenaltyFromCurses = (c.effects||[]).reduce((acc,ef)=> ef.type==="curseToHit" ? acc + (ef.value||0) : acc, 0);

    const roll20 = d(20);
    const toHit = roll20 + MAG - faeykaiPenalty + humanToHit - maskPenalty - toHitPenaltyFromCurses;
    const hit = toHit >= (enemy.defense||0);

    lines.push(
      `üéØ Trafienie: k20=${roll20} + MAG(${MAG})` +
      (faeykaiPenalty? " ‚àí Faeykai(‚àí5)": "") +
      (humanToHit? " + human(+2)" : "") +
      (maskPenalty? ` ‚àí maska(‚àí${maskPenalty})`:"") +
      (toHitPenaltyFromCurses? ` ‚àí klƒÖtwy(‚àí${toHitPenaltyFromCurses})`:"") +
      ` = ${toHit} vs Obrona ${enemy.defense} ‚Üí ${hit? "‚úÖ":"‚ùå"}`
    );

    if (!hit) return addLog(lines.join("\n"));

    if (spell.type==="damage") {
      const rollDmg = d(spell.dmgDie);
      const mod = statMod(MAG);
      const humanDmg = (c.race==="Cz≈Çowiek" && c.humanBuff?.type==="dmg") ? 2 : 0;
      const raw = rollDmg + mod + humanDmg;
      const reduced = Math.max(0, raw - (enemy.magicDefense||0));
      lines.push(`üí• Obra≈ºenia: k${spell.dmgDie}=${rollDmg} + mod(MAG)=${mod}${humanDmg? " + human(+2)": ""} = ${raw}`);
      lines.push(`üõ°Ô∏è Redukcja magiƒÖ: ‚àí${enemy.magicDefense||0} ‚Üí ${reduced}`);
      addLog(lines.join("\n"));
      damageEnemyInstance(enemy.id, reduced);
      return;
    }

    // O≈õlepienie ‚Äì w tym szkielecie jedynie log
    lines.push("üåë O≈õlepienie (efekt) ‚Äî do rozbudowy wg zasad status√≥w.");
    addLog(lines.join("\n"));
  };

  /* ===================== RENDER (czƒô≈õƒá g≈Ç√≥wna) ===================== */
  return (
    <div style={{ padding: 16 }}>
      <div style={{ display: "flex", alignItems: "center", gap: 12, marginBottom: 8 }}>
        <h2 style={{ margin: 0 }}>üïí Tura: {turn}</h2>
        <button onClick={nextTurn}>‚û°Ô∏è Nastƒôpna tura</button>
      </div>

      <div style={{ display: "grid", gridTemplateColumns: "2fr 1fr 1fr", gap: 16 }}>
        {/* LEWA KOLUMNA ‚Äî Postacie + Test walki */}
        <div>
          <h3>1) Postacie</h3>
          {sets.map((c, i) => (
            <div key={i} style={{ border: "1px solid #ccc", padding: 8, marginBottom: 8 }}>
              <div style={{ display: "flex", justifyContent: "space-between", alignItems:"center" }}>
                <strong>Postaƒá {i + 1}</strong>
                <label style={{ display: "flex", alignItems: "center", gap: 6 }}>
                  <input type="radio" name="active" checked={activeSet===i} onChange={()=>setActiveSet(i)} />
                  Aktywna
                </label>
              </div>

              <div>Imiƒô: <input value={c.name} onChange={e => setSets(prev => { const n=[...prev]; n[i]={...n[i], name:e.target.value}; return n; })} /></div>
              <div>Rasa:&nbsp;
                <select value={c.race} onChange={e => setSets(prev => { const n=[...prev]; n[i]={...n[i], race:e.target.value}; return n; })}>
                  <option>Cz≈Çowiek</option><option>Elf</option><option>Krasnolud</option><option>Faeykai</option>
                </select>
              </div>
              <div>Klasa:&nbsp;
                <select value={c.clazz} onChange={e => setSets(prev => { const n=[...prev]; n[i]={...n[i], clazz:e.target.value}; return n; })}>
                  <option>Wojownik</option><option>≈Åucznik</option><option>Strzelec</option><option>Mag</option><option>Dyplomata</option>
                </select>
              </div>

              <div style={{ display:"grid", gridTemplateColumns:"repeat(5,1fr)", gap:6, marginTop:6 }}>
                {["STR","DEX","PER","MAG","CHA"].map(k=>(
                  <label key={k}>{k}
                    <input type="number" value={c[k] ?? ""} onChange={e=>setSets(prev=>{ const n=[...prev]; n[i]={...n[i],[k]: e.target.value===""? null : Number(e.target.value)}; return n; })} disabled={lockedSets[i]} />
                    <small>mod: {c[k]!=null? statMod(Number(c[k])):"-"}</small>
                  </label>
                ))}
              </div>

              <div style={{ display:"grid", gridTemplateColumns:"repeat(4,1fr)", gap:6, marginTop:6 }}>
                <label>HP<input type="number" value={c.hp} onChange={e=>setSets(prev=>{ const n=[...prev]; n[i]={...n[i], hp:Number(e.target.value)}; return n; })} /></label>
                <label>Max HP<input type="number" value={c.maxHp} onChange={e=>setSets(prev=>{ const n=[...prev]; n[i]={...n[i], maxHp:Number(e.target.value)}; return n; })} /></label>
                <label>Esencja<input type="number" value={c.essence} onChange={e=>setSets(prev=>{ const n=[...prev]; n[i]={...n[i], essence:Number(e.target.value)}; return n; })} /></label>
                <label>Max Esencja<input type="number" value={c.maxEssence} onChange={e=>setSets(prev=>{ const n=[...prev]; n[i]={...n[i], maxEssence:Number(e.target.value)}; return n; })} /></label>
                <label>Pancerz<input type="number" value={c.armor} onChange={e=>setSets(prev=>{ const n=[...prev]; n[i]={...n[i], armor:Number(e.target.value)}; return n; })} /></label>
                <label>Obrona magii<input type="number" value={c.magicDefense} onChange={e=>setSets(prev=>{ const n=[...prev]; n[i]={...n[i], magicDefense:Number(e.target.value)}; return n; })} /></label>
                <div>Akcje: {c.actionsLeft}</div>
                <div>Maska: {c.race==="Faeykai" ? (c.faeykaiMaskBroken? "üî¥ pƒôkniƒôta" : "üü¢ sprawna") : "-"}</div>
              </div>

              {/* Zatwierd≈∫ / Odpoczynek */}
              <div style={{ display: "flex", gap: 8, marginTop: 8 }}>
                <button onClick={() => lockSet(i)} disabled={lockedSets[i]}>‚úîÔ∏è Zatwierd≈∫</button>
                <button onClick={() => restSet(i)}>üí§ Odpocznij</button>
              </div>

              {/* Pasywki rasowe */}
              <RacePassivesPanel c={c} i={i} />

              {/* Podnie≈õ sojusznika (25% max HP) */}
              <div style={{ marginTop: 8 }}>
                <label>Podnie≈õ sojusznika:&nbsp;
                  <select
                    value={c.reviveChoice ?? ""}
                    onChange={(e)=>{
                      const val = e.target.value===""? null : Number(e.target.value);
                      setSets(prev => { const n=[...prev]; n[i] = { ...n[i], reviveChoice: val }; return n; });
                    }}
                  >
                    <option value="">‚Äî</option>
                    {sets.map((s, idx)=> (idx!==i && (s.hp||0)<=0) ? <option key={idx} value={idx}>Postaƒá {idx+1}</option> : null)}
                  </select>
                </label>
                <button
                  onClick={()=>{
                    const t = sets[i].reviveChoice;
                    if (t==null) return addLog("‚ùå Wybierz sojusznika do podniesienia.");
                    if (!spendPlayerAction(i)) return addLog("‚ùå Brak akcji.");
                    const heal = Math.floor((sets[t].maxHp||20)*0.25);
                    setSets(prev => {
                      const n=[...prev]; const trg={...n[t]};
                      trg.hp=heal; trg.dwarfHibernating=false; trg.dwarfHibernateTurns=0; trg.dwarfPassiveArmed=false;
                      n[t]=trg; return n;
                    });
                    addLog(`üõ°Ô∏è P${i+1} podnosi P${t+1} ‚Üí HP = ${heal}.`);
                  }}
                  disabled={sets[i].reviveChoice==null}
                  style={{ marginLeft: 8 }}
                >
                  üõ°Ô∏è Podnie≈õ
                </button>
              </div>
            </div>
          ))}

          {/* Test walki (gracz) */}
          <div style={{ border: "1px solid #ddd", borderRadius: 8, padding: 12 }}>
            <h3>2) Test walki (gracz ‚Üí wr√≥g)</h3>
            <div style={{ display: "grid", gridTemplateColumns:"repeat(3,1fr)", gap:8 }}>
              <label>Bro≈Ñ
                <select value={weaponChoice} onChange={e=>setWeaponChoice(e.target.value)}>
                  <option value="sword">Miecz kr√≥tki (STR)</option>
                  <option value="bow">≈Åuk (PER)</option>
                  <option value="staff">Kij magiczny (MAG)</option>
                </select>
              </label>
              <label>Wr√≥g (cel)
                <select value={targetEnemyId || selectedEnemyId || ""} onChange={e=>setTargetEnemyId(e.target.value)}>
                  <option value="">‚Äî</option>
                  {enemies.map(e => <option key={e.id} value={e.id}>{e.name}</option>)}
                </select>
              </label>
              <label>Esencja aktywnego
                <input type="number" value={getActiveChar().essence} readOnly />
              </label>
            </div>
            <div style={{ marginTop: 8, display:"flex", gap:8 }}>
              <button onClick={doPlayerAttack}>‚öîÔ∏è Wykonaj atak</button>
            </div>

            <div style={{ borderTop:"1px solid #eee", marginTop:8, paddingTop:8 }}>
              <h4>Zaklƒôcia (gracz)</h4>
              <div style={{ display:"grid", gridTemplateColumns:"repeat(3,1fr)", gap:8 }}>
                <label>Zaklƒôcie
                  <select value={playerSpell} onChange={e=>setPlayerSpell(e.target.value)}>
                    {Object.keys(PLAYER_SPELLS).map(n=><option key={n} value={n}>{n}</option>)}
                  </select>
                </label>
                <label>Cel leczenia (dla Zasklepienia)
                  <select value={healTarget} onChange={e=>setHealTarget(Number(e.target.value))}>
                    {sets.map((_, idx)=><option key={idx} value={idx}>Postaƒá {idx+1}</option>)}
                  </select>
                </label>
                <label>Obrona magii celu
                  <input type="number" value={(enemies.find(e=>e.id===(targetEnemyId||selectedEnemyId))?.magicDefense)||0} readOnly />
                </label>
              </div>
              <div style={{ marginTop: 8 }}>
                <button onClick={castPlayerSpell}>‚ú® Rzuƒá zaklƒôcie</button>
              </div>
            </div>
          </div>
        </div>

        {/* ≈öRODKOWA KOLUMNA ‚Äî Wrogowie */}
        <div>
          <h3>3) Wrogowie</h3>
          <div style={{ border: "1px solid #ddd", borderRadius: 8, padding: 10, marginBottom: 10 }}>
            <h4>Konfiguracja</h4>
            <div style={{ display:"grid", gridTemplateColumns:"1fr 1fr", gap:8 }}>
              {Object.keys(enemyTypes).map(typeName => (
                <label key={typeName}>{typeName}:&nbsp;
                  <input
                    type="number"
                    min={0}
                    value={roster[typeName] ?? 0}
                    onChange={(e)=>setRoster(prev=>({ ...prev, [typeName]: Number(e.target.value) }))}
                  />
                </label>
              ))}
            </div>
            <button style={{ marginTop: 8 }} onClick={createEnemies}>‚ûï Dodaj do walki</button>
          </div>

          {enemies.length===0 ? (
            <p style={{ opacity:.7 }}>Brak aktywnych wrog√≥w ‚Äî dodaj ich powy≈ºej.</p>
          ) : enemies.map(e => (
            <div key={e.id} style={{ border:"1px solid #ddd", borderRadius:8, padding:8, marginBottom:8, background: (selectedEnemyId===e.id?"#eef":"#fff") }}>
              <label style={{ display:"flex", alignItems:"center", gap:6 }}>
                <input type="radio" name="enemy" checked={selectedEnemyId===e.id} onChange={()=>setSelectedEnemyId(e.id)} />
                <strong>{e.name}</strong>
              </label>
              <div>HP {e.hp}/{e.maxHp} | Esencja {e.essence}/{e.maxEssence} | Akcje: {e.actionsLeft}</div>
              <div>Obrona: {e.defense} | Pancerz: {e.armor} | Obrona magii: {e.magicDefense}</div>
              <div>Efekty: B≈Çogos≈Çawie≈Ñstwo {e.bless?.turnsLeft||0}t (+{e.bless?.value||0}/turƒô), KlƒÖtwa {e.cursed||0}t</div>
            </div>
          ))}
        </div>
        {/* PRAWA KOLUMNA ‚Äî Atak wroga */}
        <div>
          <h3>4) Atak wroga</h3>
          <div style={{ border: "1px solid #ddd", borderRadius: 8, padding: 10 }}>
            <label>Wybrany wr√≥g:&nbsp;
              <select value={selectedEnemyId || ""} onChange={(e)=>setSelectedEnemyId(e.target.value)}>
                <option value="">‚Äî</option>
                {enemies.map(e => <option key={e.id} value={e.id}>{e.name}</option>)}
              </select>
            </label>

            <div style={{ marginTop: 8, display:"grid", gridTemplateColumns:"1fr 1fr", gap:8 }}>
              <label>Bro≈Ñ
                <select value={enemyWeaponChoice} onChange={(e)=>setEnemyWeaponChoice(e.target.value)}>
                  <option value="sword">Miecz kr√≥tki (STR)</option>
                  <option value="bow">≈Åuk (PER)</option>
                  <option value="staff">Kij magiczny (MAG)</option>
                </select>
              </label>
              <label>Cel ‚Üí Postaƒá
                <select value={enemyTargetPlayer} onChange={(e)=>setEnemyTargetPlayer(Number(e.target.value))}>
                  {sets.map((_, idx)=> <option key={idx} value={idx}>Postaƒá {idx+1}</option>)}
                </select>
              </label>
            </div>

            <div style={{ marginTop: 6, display:"flex", gap:8 }}>
              <button onClick={()=>{
                const instId = selectedEnemyId;
                if (!instId) return addLog("‚ùå Wybierz wroga.");
                const inst = enemies.find(e=>e.id===instId);
                if (!inst) return;
                if ((inst.actionsLeft||0) <= 0) return addLog("‚ùå Wr√≥g nie ma akcji.");

                const targetIndex = enemyTargetPlayer;
                const target = sets[targetIndex];
                const w = weaponData[enemyWeaponChoice];

                const roll20 = d(20);
                const need = (inst.toHit || 0) + (inst.cursed? 3 : 0);
                const hit = roll20 >= need;

                const lines = [
                  `üëπ ${inst.name} atakuje (bro≈Ñ: ${w.name}) ‚Üí Postaƒá ${targetIndex+1}`,
                  `üéØ Trafienie: k20=${roll20} vs pr√≥g ${need}${inst.cursed? " (przeklƒôty +3)":" "}‚Üí ${hit? "‚úÖ":"‚ùå"}`
                ];
                if (!hit) { addLog(lines.join("\n")); return; }

                let incoming = d(w.dmgDie);
                lines.push(`üí• Rzut na obra≈ºenia: k${w.dmgDie}=${incoming}`);

                // Hibernacja
                if (target.dwarfHibernating) {
                  lines.push(`üõå Cel w hibernacji ‚Äî obra≈ºenia zignorowane.`);
                  // spalenie akcji
                  setEnemies(prev => prev.map(e => e.id===instId ? { ...e, actionsLeft: Math.max(0,(e.actionsLeft||0)-1) } : e));
                  addLog(lines.join("\n"));
                  return;
                }

                // Pancerz
                incoming = Math.max(0, incoming - Number(target.armor||0));
                lines.push(`üõ°Ô∏è Redukcja: ‚àí Pancerz (${target.armor||0}) ‚Üí ${incoming}`);

                // Tarcza maga (je≈õli u≈ºywasz tarcz)
                if ((target.mageShield||0) > 0 && incoming > 0) {
                  const use = Math.min(target.mageShield, incoming);
                  const reflected = use;
                  incoming = Math.max(0, incoming - use);
                  setSets(prev => {
                    const n=[...prev]; const t={...n[targetIndex]};
                    t.mageShield = Math.max(0, (t.mageShield||0) - use);
                    n[targetIndex]=t; return n;
                  });
                  lines.push(`üîÆ Tarcza Maga: ‚àí${use}, odbicie ${use} w ${inst.name}`);
                  if (reflected>0) damageEnemyInstance(instId, reflected);
                }

                if (incoming>0) {
                  let triggeredHibernate = false;
                  setSets(prev => {
                    const n=[...prev]; const t={...n[targetIndex]};
                    const before = t.hp||0;
                    t.hp = Math.max(0, before - incoming);

                    // Maska Faeykai
                    if (t.race==="Faeykai") {
                      const thr = Math.ceil((t.maxHp||20) * 0.21);
                      if (!t.faeykaiMaskBroken && t.hp < thr) {
                        t.faeykaiMaskBroken = true;
                        lines.push(`üò± Maska Faeykai pƒôk≈Ça przy ${t.hp} HP (<21% max)!`);
                      }
                    }

                    // Hibernacja krasnoluda, je≈õli uzbrojona i spadli≈õmy do 0
                    if (t.race==="Krasnolud" && t.dwarfPassiveArmed && before>0 && t.hp<=0) {
                      t.dwarfHibernating = true;
                      t.dwarfHibernateTurns = 2;
                      t.dwarfPassiveArmed = false;
                      triggeredHibernate = true;
                    }

                    n[targetIndex]=t; return n;
                  });
                  lines.push(`‚ù§Ô∏è HP Postaci ${targetIndex+1} ‚àí${incoming}`);
                  if (triggeredHibernate) lines.push("‚õèÔ∏è Krasnolud: wchodzi w hibernacjƒô na 2 tury.");
                }

                // spal akcjƒô wroga
                setEnemies(prev => prev.map(e => e.id===instId ? { ...e, actionsLeft: Math.max(0,(e.actionsLeft||0)-1) } : e));
                addLog(lines.join("\n"));
              }}>üëπ Atak broniƒÖ</button>

              {/* Zaklƒôcia wroga (skr√≥t ‚Äì 2 najwa≈ºniejsze) */}
              <button onClick={()=>{
                const instId = selectedEnemyId;
                if (!instId) return addLog("‚ùå Wybierz wroga.");
                const inst = enemies.find(e=>e.id===instId);
                if (!inst) return;
                if ((inst.actionsLeft||0) <= 0) return addLog("‚ùå Wr√≥g nie ma akcji.");
                if (!inst.spells?.length) return addLog("‚ùå Wr√≥g nie ma zaklƒôƒá.");

                // prosty wyb√≥r: je≈õli to Kultysta ‚Äì ‚ÄûMagiczny pocisk‚Äù; je≈õli Szpieg ‚Äì ‚ÄûWybuch energii‚Äù
                const prefer = inst.type==="Szpieg Magmaratora" && inst.spells.includes("Wybuch energii")
                  ? "Wybuch energii"
                  : (inst.spells.includes("Magiczny pocisk") ? "Magiczny pocisk" : inst.spells[0]);

                // koszt
                const costMap = { "Magiczny pocisk":3, "Wybuch energii":5, "Mroczny Pakt":2, "Wyssanie ≈ºycia":5 };
                const dmgMap  = { "Magiczny pocisk":6, "Wybuch energii":4 };
                const cost = costMap[prefer] ?? 3;

                if ((inst.essence||0) < cost) return addLog(`‚ùå ${inst.name} ma zbyt ma≈Ço esencji (${inst.essence}) na ${prefer} (koszt ${cost}).`);

                // spal esencjƒô i akcjƒô
                setEnemies(prev => prev.map(e => e.id===instId ? { ...e, essence: (e.essence||0)-cost, actionsLeft: Math.max(0,(e.actionsLeft||0)-1) } : e));

                // wylicz trafienie
                const roll20 = d(20);
                const need = (inst.toHit||0) + (inst.cursed?3:0);
                const ok = roll20 >= need;

                const playerIdx = enemyTargetPlayer;
                const trg = sets[playerIdx];

                const lines = [
                  `ü™Ñ ${inst.name} rzuca ‚Äû${prefer}‚Äù ‚Üí P${playerIdx+1}`,
                  `üéØ Trafienie: k20=${roll20} vs pr√≥g ${need}${inst.cursed? " (przeklƒôty +3)" : ""} ‚Üí ${ok? "‚úÖ":"‚ùå"}`
                ];
                if (!ok) { addLog(lines.join("\n")); return; }

                // obra≈ºenia magiczne
                const dmgDie = dmgMap[prefer] || 6;
                let incoming = Math.max(0, d(dmgDie) - Number(trg.magicDefense||0));
                lines.push(`üí• Obra≈ºenia: k${dmgDie} ‚àí Obrona magii(${trg.magicDefense||0}) = ${incoming}`);

                // tarcza maga
                if ((trg.mageShield||0) > 0 && incoming > 0) {
                  const use = Math.min(trg.mageShield, incoming);
                  const reflected = use;
                  incoming = Math.max(0, incoming - use);
                  setSets(prev => {
                    const n=[...prev]; const t={...n[playerIdx]};
                    t.mageShield = Math.max(0, (t.mageShield||0) - use);
                    n[playerIdx]=t; return n;
                  });
                  lines.push(`üîÆ Tarcza Maga: ‚àí${use}, odbicie ${use} w ${inst.name}`);
                  if (reflected>0) damageEnemyInstance(instId, reflected);
                }

                if (incoming>0) {
                  setSets(prev => {
                    const n=[...prev]; const t={...n[playerIdx]};
                    const before = t.hp||0;
                    t.hp = Math.max(0, before - incoming);

                    // Maska Faeykai
                    if (t.race==="Faeykai") {
                      const thr = Math.ceil((t.maxHp||20) * 0.21);
                      if (!t.faeykaiMaskBroken && t.hp < thr) {
                        t.faeykaiMaskBroken = true;
                        lines.push(`üò± Maska Faeykai pƒôk≈Ça przy ${t.hp} HP (<21% max)!`);
                      }
                    }

                    n[playerIdx]=t; return n;
                  });
                  lines.push(`‚ù§Ô∏è HP Postaci ${playerIdx+1} ‚àí${incoming}`);
                }

                addLog(lines.join("\n"));
              }}>ü™Ñ Zaklƒôcie (auto wyb√≥r)</button>
            </div>
          </div>
        </div>
      </div>

      {/* LOG */}
      <div style={{ marginTop: 16, background: "#111", color: "#eee", padding: 10, borderRadius: 8, maxHeight: 260, overflow: "auto", fontSize: 13 }}>
        {log.map((line, i) => <div key={i}>{line}</div>)}
      </div>
    </div>
  );
}

